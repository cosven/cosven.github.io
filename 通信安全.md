title: 通信安全 - IPSec
date: 2015-06-21 23:44:31
tags: [Network, security]
categories: 网络相关
---

** 技术的进步在于不断的折腾 ... **

<!--more-->

## 概述

如何数据位秘密地，未被篡改的从源端发送到接收方，以及如何将有害的数据排除在外，这就是我们平常所说的 `通信安全`。

** Internet 缺乏安全性，我们要保证Internet尽量的安全，那么我们应该在Internet的哪一层动手？**

> 很多安全专家认为，为了真正的安全，必须建立一个端到端的加密和完整性检查。也就是说：在 `应用层` 上建立这样一个安全保证机制。源进程对数据加密，目标进程对数据解密，这样做的好处是：**无论在这其中进行了怎样的修改，都可以被检测到**, 但是这也存在一个弊端：它必须改变所有的应用系统。

> 也有另外很多专家认为：没有人愿意以任何一种方式来修改已有的程序，所以 `网络层` 应该认证或者加密数据包。

这两个方案最后的综合讨论结果提出了一个 `IPSec（IP安全，IP security）`的设计方案。


## IPSec

`IPSec` 是一个 **设计方案**，这个方案总的来说描述了 一个多服务、多算法和多粒度的框架。

> 空算法：

### IPSec 特点

#### 多服务

IPSec这个设计方案支持多种服务的原因在于考虑了并不是每个人都愿意为所有的服务、时间支付费用，所以IPSec按照“点菜”的方式来提供这些服务。

这些服务包括那些呢？最主要的服务就是`保密性`和`数据完整性`，以及针对`重放攻击（即入侵者重放一次回话过程）的保护`。这些服务都是建立在`对称密钥密码学`。

> 重放攻击：攻击者利用你的验证之后的数据进行一些需要授权的操作。比如说，您登陆之后，服务器给你一个密钥，用来进行之后的操作，攻击者可以通过截取你这个密钥，进行后续的攻击。这样子，他就不需要得知你的用户名和密码，他也能进行操作（大概这样理解）

> 对称密钥密码学：基本思想就是使用相同的密钥来进行加密和解密。

#### 多算法

IPSec支持多算法的考虑在于任何一个现在被认为安全的算法在将来都可能都会被攻破。IPSec设计与算法无关的好处是，即使某个特殊的算法将来被攻破，这个框架仍然可以保存下来。

#### 多粒度

IPSec支持多粒度，就是说它小到可以保护单个TCP连接，大一点也能保护一对主机之间的所有流量，或者一对安全路由器之间的所有流浪。



### IPSec中使用的连接

关于IPSec这个框架，它落在IP层，但是它是面向连接的。（它建立一个密钥，并且在一定长的时间内使用该密钥，在本质上，这就是一种连接）。

在IPSec环境中，一个“连接”成称为一个安全关联（`SA，security association`）。SA是什么？
SA是两个端点之间的单纯连接，他有一个与之关联的安全**标识符**，如果两个方向上都需要安全通信的话，则要求使用两个安全关联。数据包携带着安全标识符通过这些安全连接，而标识符是用来查询密钥和其他有关安全信息。


### IPSec 内容

##### 抽象描述

IPSec这个设计方案包含两个主要部分。
第一部分 _描述_ 两个新的头，这两个新的头可以被加入到数据包中以便携带安全标识符、完整性控制数据和其他信息。（注: 使用的时候选择一个头使用）
另一部分是`Internet安全关联及密钥管理协议（ISAKMP）`。

下面我们主要讨论IPSec第一部分的内容，即两个新的头的相关知识。


### IPSec 两种模式

IPSec 有两种使用模式。

在传输模式中，IPSec头被直接插在 _IP头_ 的后面，IP头的Protocol字段进行相应修改，以表明一个IPSec头紧跟在后面。IPSec头中包含了安全信息：主要是 `SA标识符`、新的`序号`，可能还有`有效载荷数据的完整性检查信息`。

在隧道模式中，整个IP数据包都被封装到一个新IP数据包的 _数据部分_，整个新IP数据包有一个全新的 _IP头_。

#### IPSec 描述的两个头

之前提到了IPsec描述了两个新的头，其中一个就是`认证头（AH，AuthenticationHeader）`，他提供 _数据完整性检查_ 和 _防止重放攻击的安全性_，没有提供 _保密性_。

它的原理大致如下图。

![传输模式下的IPSec认证头 示意图](http://7viixf.com1.z0.glb.clouddn.com/network/IPV4传输模式下IPSec认证头.png)

** 下一个头 (Next header) ** 字段保存原始的IP包的协议。
** 安全参数索引 (Security parameters index) ** 与IP地址一同用来标识安全参数。它由发送方插入，包含了这个连接上所使用的共享密钥，一起有关连接的其他信息。
** 序号（Sequence number） ** 用来对通过一个`SA`发送的所有数据包进行编号，每个数据包都一个唯一的编号，重传的数据包也一样，这样子就可以防止重放攻击。
** 认证数据（Authentication data） ** 它包含了有效载荷的数字签名，当SA被建立时，双方协商使用哪个签名算法。

> 认证头试图保护IP数据报的所有字段，那些在传输IP分组的过程中要发生变化的字段就只能被排除在外。比如`TTL（time to live）`字段在每一跳上都要改变，所以它就不能被包含在完整性的检查范围内。


另一个IPSec头是`封装的安全有效载荷（ESP）`。

下面是一张ESP的原理图

![IPSec ESP 原理图](http://7viixf.com1.z0.glb.clouddn.com/network/ESP头的结构.png)

使用了ESP之后，我们就可以对数据进行加密，从而达到保密的功能。

**是怎样对数据进行加密的呢?**  我们可以看下面AH头和ESP头的对比得知。


#### 对比

AH和ESP有很多相同之处，ESP具备AH所有的功能，并且具有AH不具有的加密功能。所以AH以后会慢慢淘汰。

传输模式下：
![IPSec transport mode](http://7viixf.com1.z0.glb.clouddn.com/network/传输模式IPSec.jpg)
隧道模式下：
![IPSec tunnel mode](http://7viixf.com1.z0.glb.clouddn.com/network/隧道模式IPSec.jpg)


